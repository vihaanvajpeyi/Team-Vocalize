package com.example.vocalizesf2

import android.Manifest
import android.content.Intent
import android.content.pm.PackageManager
import android.net.Uri
import android.os.Build
import android.os.Bundle
import android.provider.Settings
import android.speech.tts.TextToSpeech
import android.util.Log
import android.widget.Button
import android.widget.TextView
import androidx.activity.result.contract.ActivityResultContracts
import androidx.appcompat.app.AlertDialog
import androidx.appcompat.app.AppCompatActivity
import androidx.core.content.ContextCompat
import kotlinx.coroutines.*
import java.util.*

class MainActivity : AppCompatActivity() {

    private lateinit var listenButton: Button
    private lateinit var recognizedText: TextView

    private var recorder: AudioRecorder? = null
    private var model: TFLiteModel? = null
    private var tts: TextToSpeech? = null

    private var isListening = false
    private val uiScope = CoroutineScope(Dispatchers.Main + SupervisorJob())

    // ------------------------------------------------------------
// RUNTIME PERMISSIONS (SINGLE SOURCE OF TRUTH)
// ------------------------------------------------------------
    private val REQUIRED_PERMISSIONS: Array<String>
        get() {
            val list = mutableListOf(Manifest.permission.RECORD_AUDIO)
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
                list.add(Manifest.permission.BLUETOOTH_CONNECT)
                list.add(Manifest.permission.BLUETOOTH_SCAN)
            }
            return list.toTypedArray()
        }

    private val permissionLauncher =
        registerForActivityResult(ActivityResultContracts.RequestMultiplePermissions()) { results ->
            val denied = results.filter { !it.value }.keys

            if (denied.isEmpty()) {
                Log.d("VCZ", "All permissions granted → starting listening")
                startListening()
                return@registerForActivityResult
            }

            Log.d("VCZ", "Permissions denied: $denied")

            val permanentlyDenied = denied.any { perm ->
                !shouldShowRequestPermissionRationale(perm)
            }

            if (permanentlyDenied) {
                AlertDialog.Builder(this)
                    .setTitle("Permission required")
                    .setMessage("Microphone and Bluetooth permissions are required. Enable them in App Settings.")
                    .setPositiveButton("Open Settings") { _, _ ->
                        val intent = Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS)
                        intent.data = Uri.parse("package:$packageName")
                        startActivity(intent)
                    }
                    .setNegativeButton("Cancel", null)
                    .show()
            } else {
                AlertDialog.Builder(this)
                    .setTitle("Permission required")
                    .setMessage("This app needs microphone & Bluetooth to function.")
                    .setPositiveButton("Ask again") { _, _ -> requestMissingPermissions() }
                    .setNegativeButton("Cancel", null)
                    .show()
            }
        }

    private fun hasAllPermissions(): Boolean =
        REQUIRED_PERMISSIONS.all { perm ->
            ContextCompat.checkSelfPermission(this, perm) == PackageManager.PERMISSION_GRANTED
        }

    private fun requestMissingPermissions() {
        val missing = REQUIRED_PERMISSIONS.filter { perm ->
            ContextCompat.checkSelfPermission(this, perm) != PackageManager.PERMISSION_GRANTED
        }.toTypedArray()

        if (missing.isNotEmpty()) permissionLauncher.launch(missing)
    }

    // ------------------------------------------------------------
// ON CREATE
// ------------------------------------------------------------
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        Log.d("VCZ", "MainActivity ONCREATE")

        listenButton = findViewById(R.id.listenButton)
        recognizedText = findViewById(R.id.recognizedText)

// Load TFLite model
        try {
            model = TFLiteModel(this)
            Log.d("VCZ", "MODEL LOADED SUCCESSFULLY")
        } catch (e: Exception) {
            Log.e("VCZ", "Model load failed", e)
            recognizedText.text = "Model failed to load"
        }

// Setup TTS
        tts = TextToSpeech(this) { status ->
            if (status == TextToSpeech.SUCCESS) {
                tts?.language = Locale("hi", "IN")
                Log.d("VCZ", "TTS READY")
            } else {
                Log.w("VCZ", "TTS init failed: $status")
            }
        }

// Button behavior
        listenButton.setOnClickListener {
            Log.d("VCZ", "BUTTON CLICKED")

            if (isListening) {
                stopListening()
            } else {
                if (!hasAllPermissions()) {
                    Log.d("VCZ", "Permissions missing → requesting")
                    requestMissingPermissions()
                    return@setOnClickListener
                }

                startListening()
            }
        }
    }

    // ------------------------------------------------------------
// START LISTENING
// ------------------------------------------------------------
    private fun startListening() {
        Log.d("VCZ", "startListening()")

        if (!hasAllPermissions()) {
            requestMissingPermissions()
            return
        }

// Try to improve Bluetooth microphone routing
        try {
            val am = getSystemService(AUDIO_SERVICE) as? android.media.AudioManager
            am?.startBluetoothSco()
            am?.isBluetoothScoOn = true
        } catch (e: Exception) {
            Log.w("VCZ", "Bluetooth SCO start failed: ${e.message}")
        }

        recorder = AudioRecorder.getInstance(16000, 2.0).also { rec ->
            rec.setOnDataReadyListener { pcm ->

                uiScope.launch(Dispatchers.Default) {
                    try {
                        val melBatched = Preprocessing.audioToMelspectrogram(pcm)
                        val mel = melBatched.getOrNull(0) ?: arrayOf<FloatArray>()

                        val nMels = mel.size
                        val tFrames = if (nMels > 0) mel[0].size else 0

                        val input = Array(nMels) { m ->
                            Array(tFrames) { t ->
                                floatArrayOf(mel[m][t])
                            }
                        }

                        val predicted = model?.predict(input) ?: "unknown"
                        Log.d("VCZ", "Predicted: $predicted")

                        withContext(Dispatchers.Main) {
                            recognizedText.text = predicted
                            tts?.speak(predicted, TextToSpeech.QUEUE_FLUSH, null, "utt1")
                        }

                    } catch (e: Exception) {
                        Log.e("VCZ", "Error during inference", e)
                    }
                }
            }

            rec.start()
            Log.d("VCZ", "Recorder STARTED")
        }

        listenButton.text = "LISTENING..."
        isListening = true
    }

    // ------------------------------------------------------------
// STOP LISTENING
// ------------------------------------------------------------
    private fun stopListening() {
        Log.d("VCZ", "stopListening()")

        recorder?.stop()
        recorder = null
        isListening = false

        listenButton.text = "START LISTENING"

        try {
            val am = getSystemService(AUDIO_SERVICE) as? android.media.AudioManager
            am?.stopBluetoothSco()
            am?.isBluetoothScoOn = false
        } catch (e: Exception) {
            Log.w("VCZ", "SCO stop failed: ${e.message}")
        }
    }

    // ------------------------------------------------------------
// DESTROY
// ------------------------------------------------------------
    override fun onDestroy() {
        super.onDestroy()
        Log.d("VCZ", "onDestroy()")

        recorder?.stop()
        tts?.shutdown()
        model?.close()
        uiScope.cancel()
    }
}
