package com.example.vocalizesf2

import android.media.AudioFormat
import android.media.AudioRecord
import android.media.MediaRecorder
import android.util.Log
import kotlin.concurrent.thread
import kotlin.math.min

class AudioRecorder private constructor(
    private val sampleRate: Int,
    private val durationSec: Double
) {

    companion object {
        @Volatile private var instance: AudioRecorder? = null

        fun getInstance(sampleRate: Int, durationSec: Double): AudioRecorder {
            return instance ?: synchronized(this) {
                instance ?: AudioRecorder(sampleRate, durationSec).also { instance = it }
            }
        }
    }

    private var audioRecord: AudioRecord? = null
    private var isRecording = false
    private var bufferSize = 0

    private var callback: ((ShortArray) -> Unit)? = null

    fun setOnDataReadyListener(cb: (ShortArray) -> Unit) {
        callback = cb
    }

    fun start() {
        if (isRecording) return

        bufferSize = AudioRecord.getMinBufferSize(
            sampleRate,
            AudioFormat.CHANNEL_IN_MONO,
            AudioFormat.ENCODING_PCM_16BIT
        )

        audioRecord = AudioRecord(
            MediaRecorder.AudioSource.MIC,
            sampleRate,
            AudioFormat.CHANNEL_IN_MONO,
            AudioFormat.ENCODING_PCM_16BIT,
            bufferSize
        )

        audioRecord?.startRecording()
        isRecording = true

        Log.d("VCZ", "AudioRecorder started")

        thread {
            val totalSamples = (sampleRate * durationSec).toInt()
            val pcmBuffer = ShortArray(totalSamples)
            var offset = 0

            while (isRecording) {
                val remaining = totalSamples - offset
                val chunk = ShortArray(min(bufferSize, remaining))

                val read = audioRecord?.read(chunk, 0, chunk.size) ?: 0
                if (read > 0) {
                    System.arraycopy(chunk, 0, pcmBuffer, offset, read)
                    offset += read
                }

                if (offset >= totalSamples) {
                    val fullPCM = pcmBuffer.copyOf()
                    callback?.invoke(fullPCM)
                    offset = 0
                }
            }
        }
    }

    fun stop() {
        isRecording = false
        audioRecord?.stop()
        audioRecord?.release()
        audioRecord = null

        Log.d("VCZ", "AudioRecorder stopped")
    }
}
