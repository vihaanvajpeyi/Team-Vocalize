package com.example.vocalize

import android.media.AudioFormat
import android.media.AudioRecord
import android.media.MediaRecorder
import kotlinx.coroutines.*

class AudioCapture(
    private val callback: (FloatArray) -> Unit,
    private val sampleRate: Int = 16000,
    private val emitMs: Long = 200L
) {
    private var record: AudioRecord? = null
    private var job: Job? = null
    private val bufferSeconds = 1

    fun start() {
        stop()
        val minBuf = AudioRecord.getMinBufferSize(sampleRate,
            AudioFormat.CHANNEL_IN_MONO,
            AudioFormat.ENCODING_PCM_16BIT)
        val readSize = maxOf(minBuf, sampleRate / 10) // read at least 100ms
        val shortBuf = ShortArray(readSize / 2)

        record = AudioRecord(MediaRecorder.AudioSource.MIC, sampleRate,
            AudioFormat.CHANNEL_IN_MONO, AudioFormat.ENCODING_PCM_16BIT, readSize)
        record?.startRecording()

        val ring = FloatArray(sampleRate * bufferSeconds)
        var writePtr = 0
        val scope = CoroutineScope(Dispatchers.IO)
        job = scope.launch {
            while (isActive) {
                val r = record?.read(shortBuf, 0, shortBuf.size) ?: 0
                if (r > 0) {
                    for (i in 0 until r) {
                        ring[writePtr] = shortBuf[i] / 32768.0f
                        writePtr++
                        if (writePtr >= ring.size) writePtr = 0
                    }
                }
                delay(emitMs)
                // emit latest 1s window
                val out = FloatArray(ring.size)
                var idx = writePtr
                for (i in 0 until ring.size) {
                    out[i] = ring[idx]
                    idx++
                    if (idx >= ring.size) idx = 0
                }
                callback(out)
            }
        }
    }

    fun stop() {
        job?.cancel()
        job = null
        try { record?.stop() } catch (e: Exception) {}
        try { record?.release() } catch (e: Exception) {}
        record = null
    }
}
