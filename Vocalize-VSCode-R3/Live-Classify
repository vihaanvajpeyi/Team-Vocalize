import serial
import time
import joblib
import numpy as np
import pandas as pd
import sys

# --- CONFIG ---
SERIAL_PORT = '/dev/cu.SLAB_USBtoUART'
BAUD_RATE = 115200
MODEL_PATH = 'emg_classifier.pkl'
LABELS = ['base', 'hi', 'bye']
FEATURE_NAMES = ['MAV', 'RMS', 'ZC', 'SSC', 'WL', 'rawPeak']

# --- LOAD MODEL ---
print("Loading trained model...")
try:
    model = joblib.load(MODEL_PATH)
    print("‚úÖ Model loaded successfully.\n")
except Exception as e:
    print(f"‚ùå Error loading model: {e}")
    sys.exit(1)

# --- CONNECT TO SERIAL ---
print(f"Connecting to {SERIAL_PORT}...")
try:
    ser = serial.Serial(SERIAL_PORT, BAUD_RATE, timeout=2)
    time.sleep(3)
    ser.reset_input_buffer()
    print(f"‚úÖ Connected to {SERIAL_PORT} at {BAUD_RATE} baud.\n")
except Exception as e:
    print(f"‚ùå Error connecting to serial port: {e}")
    sys.exit(1)

print("--- LIVE EMG CLASSIFICATION ---")
print("Press Ctrl+C to stop.\n")

# --- VERIFY DATA STREAM ---
print("‚è≥ Checking serial stream (5 seconds)...")
start = time.time()
lines_received = 0

while time.time() - start < 5:
    if ser.in_waiting > 0:
        try:
            line = ser.readline().decode(errors='ignore').strip()
            if line:
                print("Raw:", line)
                lines_received += 1
        except Exception as e:
            print(f"‚ö†Ô∏è Serial read error: {e}")
    time.sleep(0.02)



print(f"\n‚úÖ Serial data detected ({lines_received} lines). Starting classification...\n")

# --- LIVE CLASSIFICATION ---
try:
    while True:
        line = ser.readline().decode(errors='ignore').strip()
        if not line:
            continue

        try:
            parts = [float(x) for x in line.split(',') if x != '']
            if len(parts) < 7:
                continue  # skip incomplete data

            # Ignore timestamp / counter (first value)
            features = parts[1:7]

            # Create dataframe for model
            X = pd.DataFrame([features], columns=FEATURE_NAMES)

            # Predict
            pred = model.predict(X)[0]

            # Symbolic output
            symbols = {'base': '-', 'hi': 'HI', 'bye': 'BYE'}
            print(symbols.get(pred, pred), flush=True)

        except ValueError:
            continue
        except Exception as e:
            print(f"‚ö†Ô∏è Runtime error: {e}")

        time.sleep(0.02)

except KeyboardInterrupt:
    print("\nüõë Stopped by user.")

finally:
    ser.close()
    print("Serial connection closed.")
